# DO NOT EDIT THIS FILE!
# Please make all changes to files in ../local.
# To make changes, copy the section/stanza you want to change from ./default
# into ../local and edit there.

[SA-AwsAssets - Lookup Gen]
disabled = false
cron_schedule = 37 * * * *
description = populates kvstore lookup: sa_aws_assets
dispatch.earliest_time = -61m@m
dispatch.latest_time = -1m@m
enableSched = 1
schedule_window = auto
search = `sa_aws_assets_index` eventtype="aws_metadata_ec2_instances"\
| dedup InstanceId\
| eval\
    pub_ip_loc=mvindex('NetworkInterfaces{}.Association.PublicIp', 0),\
    category=mvjoin(lower(mvsort(mvappend(\
    "gen: sa-aws-assets",\
    "hypervisor: ".Hypervisor,\
    "image_id: ".ImageId,\
    "instance_type: ".InstanceType,\
    "launch_time: ".strftime(strptime(LaunchTime,"%FT%T.%3Q%Z"), "%x %T %Z"),\
    "monitoring: ".'Monitoring.State',\
    "public_ip: ".mvjoin('NetworkInterfaces{}.Association.PublicIp', ","),\
    "group_id: ".'SecurityGroups{}.GroupId',\
    "group_name: ".'SecurityGroups{}.GroupName',\
    "subnet_id: ".'NetworkInterfaces{}.SubnetId',\
    "vpc_id: ".'NetworkInterfaces{}.VpcId',\
    "availability_zone: ".'Placement.AvailabilityZone',\
    "region: ".Region,\
    "os_platform: ".PlatformDetails,\
    "state: ".'State.Name',\
    "tags: ".mvjoin(custom_tag, ", "),\
    "enabled: ".enabled,\
    "splunk_last_updated: ".strftime(now(), "%x %T %Z")\
    ))), "|"),\
    nt_host=mvjoin(mvdedup(lower(mvappend(\
    InstanceId,\
    mvmap('NetworkInterfaces{}.Association.PublicDnsName', mvindex(split('NetworkInterfaces{}.Association.PublicDnsName',"."),0)),\
    mvmap('NetworkInterfaces{}.PrivateDnsName', mvindex(split('NetworkInterfaces{}.PrivateDnsName',"."),0)),\
    mvmap('NetworkInterfaces{}.PrivateIpAddresses{}.Association.PublicDnsName', mvindex(split('NetworkInterfaces{}.PrivateIpAddresses{}.Association.PublicDnsName',"."),0))\
    ))), "|"),\
    dns=mvjoin(lower(dns),"|"),\
    priority="medium",\
    ip=mvjoin('NetworkInterfaces{}.PrivateIpAddress', "|"),\
    mac=mvjoin('NetworkInterfaces{}.MacAddress', "|"),\
    _last_seen=now(),\
    _key=md5(InstanceId)\
| iplocation pub_ip_loc\
| rename Country as country, City as city, lon as long\
| table _key,_last_seen,ip,mac,nt_host,dns,priority,lat,long,city,country,category\
| outputlookup key_field=_key sa_aws_assets\
| stats count

# Deprecated
[SA-AwsAssets - Lookup Cleanup]
disabled = true
cron_schedule = 47 * * * *
description = Deprecated - removes old entries from kvstore lookup: sa_aws_assets
dispatch.earliest_time = -1s
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = | inputlookup sa_aws_assets \
| where _last_seen>relative_time(now(), `sa_aws_assets_retention`) \
| outputlookup sa_aws_assets \
| stats count
